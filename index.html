<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدقق أصالة الآيفون - تأكد من جهازك</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .btn-gradient { background: linear-gradient(to right, #2563eb, #3b82f6); transition: all 0.3s ease-in-out; }
        .btn-gradient:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.2); }
        .btn-gradient:disabled { background: #9ca3af; cursor: not-allowed; }
        .result-card { transition: all 0.5s ease-in-out; transform: scale(0.95); opacity: 0; max-height: 0; overflow: hidden; }
        .result-card.show { transform: scale(1); opacity: 1; max-height: 1200px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); width: 20px; height: 20px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab { transition: all 0.3s; }
        .tab-active { background-color: #3b82f6; color: white; }
        .tab-inactive { background-color: #e5e7eb; color: #4b5563; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900"><span class="text-blue-600">الدليل الشامل</span> لفحص الآيفون</h1>
            <p class="mt-2 text-lg text-gray-600">أداة ذكية ومتكاملة لفحص أصالة ومواصفات جهازك خطوة بخطوة.</p>
        </header>

        <!-- Step 1: Main Checker Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 max-w-2xl mx-auto">
            <div class="flex flex-col items-center">
                 <h2 class="text-2xl font-semibold text-center mb-4">1. التحقق من المعرّف وتحديد المواصفات</h2>
                <div class="w-full max-w-sm mx-auto bg-gray-200 rounded-lg p-1 flex mb-4">
                    <button id="tabSerial" class="tab tab-active w-1/2 rounded-md py-2 font-semibold">الرقم التسلسلي</button>
                    <button id="tabImei" class="tab tab-inactive w-1/2 rounded-md py-2 font-semibold">IMEI</button>
                </div>
                <p id="helperText" class="text-gray-500 text-center mb-6">أدخل الرقم ليقوم الذكاء الاصطناعي بتحليله.</p>
                <div class="w-full">
                    <input type="text" id="identifierInput" placeholder="أدخل الرقم التسلسلي هنا" class="w-full px-5 py-3 text-lg text-center border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="checkButton" class="btn-gradient text-white font-bold py-3 px-10 rounded-lg mt-6 w-full sm:w-auto text-lg shadow-md flex items-center justify-center gap-2">
                    <span id="buttonText">تحليل بالذكاء الاصطناعي</span>
                    <span id="loadingSpinner" class="hidden spinner"></span>
                </button>
            </div>
        </div>
        <div id="resultContainer" class="result-card max-w-2xl mx-auto mt-6"></div>

        <!-- Step 2: AI Image Analysis -->
        <div class="max-w-2xl mx-auto mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-center mb-4">2. تحليل الصورة بالذكاء الاصطناعي</h2>
            <div class="flex flex-col items-center">
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" src="" alt="معاينة الصورة" class="mt-4 rounded-lg max-h-60 hidden shadow-md"/>
                <button id="analyzeImageButton" class="btn-gradient text-white font-bold py-3 px-10 rounded-lg mt-6 w-full sm:w-auto text-lg shadow-md" disabled>تحليل الصورة</button>
                <div id="aiImageAnalysisResult" class="mt-4 w-full text-right"></div>
            </div>
        </div>
        
        <!-- Step 3: Parts and Service History -->
        <div class="max-w-2xl mx-auto mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-center mb-4">3. التحقق من سجل القطع والخدمة</h2>
            <div class="text-right space-y-4">
                 <p class="text-gray-700">اذهب إلى <span class="font-semibold">الإعدادات > عام > حول</span>. إذا تم إجراء إصلاحات، سيظهر قسم "سجل القطع والخدمة".</p>
                <div class="p-4 rounded-lg bg-green-50 border border-green-200">
                     <h4 class="font-semibold text-green-800">قطعة أصلية من Apple</h4>
                     <p class="text-green-700">هذا يعني أن القطعة أصلية من آبل وتم تركيبها بشكل صحيح.</p>
                </div>
                <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200">
                     <h4 class="font-semibold text-yellow-800">قطعة غير معروفة</h4>
                     <p class="text-yellow-700">هذا يعني أن القطعة المُركبة إما غير أصلية، أو لا تعمل كما هو متوقع.</p>
                </div>
            </div>
        </div>

        <!-- Step 4: Battery Health Analysis -->
        <div class="max-w-2xl mx-auto mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-center mb-4">4. تحليل صحة البطارية بالذكاء الاصطناعي</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="batteryCapacity" class="font-semibold text-gray-700">الحد الأقصى للسعة (٪)</label>
                    <input type="number" id="batteryCapacity" placeholder="88" class="w-full mt-1 px-4 py-2 text-center border-2 border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="batteryCycles" class="font-semibold text-gray-700">عدد دورات الشحن (اختياري)</label>
                    <input type="number" id="batteryCycles" placeholder="550" class="w-full mt-1 px-4 py-2 text-center border-2 border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-center">
                <button id="analyzeBatteryButton" class="btn-gradient text-white font-bold py-3 px-10 rounded-lg mt-6 text-lg shadow-md">تحليل البطارية</button>
            </div>
            <div id="aiBatteryAnalysisResult" class="mt-4 w-full text-right"></div>
        </div>

        <!-- Step 5: Manual Checklist -->
        <div class="max-w-2xl mx-auto mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-center mb-4">5. قائمة الفحص اليدوي النهائية</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                <div class="text-right">
                    <h3 class="font-bold text-lg text-blue-700 mb-2">الفحص المادي</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        <li>جودة المواد</li>
                        <li>ثبات الأزرار</li>
                        <li>شعار آبل اللامع</li>
                        <li>منفذ الشحن</li>
                    </ul>
                </div>
                <div class="text-right">
                    <h3 class="font-bold text-lg text-blue-700 mb-2">فحص النظام والبرامج</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        <li>متجر App Store</li>
                        <li>المساعد الصوتي Siri</li>
                        <li>التطبيقات الأساسية</li>
                        <li>سلاسة النظام</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p><strong>إخلاء مسؤولية:</strong> هذه الأداة للمساعدة فقط. تحقق دائماً من <a href="https://checkcoverage.apple.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">موقع آبل الرسمي</a>.</p>
        </footer>
    </div>

    <script>
        const checkButton = document.getElementById('checkButton');
        const identifierInput = document.getElementById('identifierInput');
        const resultContainer = document.getElementById('resultContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeImageButton = document.getElementById('analyzeImageButton');
        const aiImageAnalysisResult = document.getElementById('aiImageAnalysisResult');
        const tabSerial = document.getElementById('tabSerial');
        const tabImei = document.getElementById('tabImei');
        const helperText = document.getElementById('helperText');
        const analyzeBatteryButton = document.getElementById('analyzeBatteryButton');
        const batteryCapacityInput = document.getElementById('batteryCapacity');
        const batteryCyclesInput = document.getElementById('batteryCycles');
        const aiBatteryAnalysisResult = document.getElementById('aiBatteryAnalysisResult');

        let imageDataBase64 = null;
        let currentCheckType = 'Serial';
        let identifiedModel = null;

        tabSerial.addEventListener('click', () => switchTab('Serial'));
        tabImei.addEventListener('click', () => switchTab('IMEI'));
        checkButton.addEventListener('click', analyzeIdentifier);
        analyzeBatteryButton.addEventListener('click', getAIBatteryAnalysis);
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            analyzeImageButton.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                imageDataBase64 = e.target.result.split(',')[1];
                analyzeImageButton.disabled = false;
            };
            reader.readAsDataURL(file);
        });
        analyzeImageButton.addEventListener('click', getAIImageAnalysis);

        function switchTab(type) {
            currentCheckType = type;
            if (type === 'Serial') {
                tabSerial.className = 'tab tab-active w-1/2 rounded-md py-2 font-semibold';
                tabImei.className = 'tab tab-inactive w-1/2 rounded-md py-2 font-semibold';
                helperText.textContent = "أدخل الرقم التسلسلي ليقوم الذكاء الاصطناعي بتحليله.";
                identifierInput.placeholder = "أدخل الرقم التسلسلي هنا";
            } else {
                tabImei.className = 'tab tab-active w-1/2 rounded-md py-2 font-semibold';
                tabSerial.className = 'tab tab-inactive w-1/2 rounded-md py-2 font-semibold';
                helperText.textContent = "أدخل IMEI ليقوم الذكاء الاصطناعي بتحليله.";
                identifierInput.placeholder = "أدخل رقم IMEI هنا";
            }
        }

        async function analyzeIdentifier() {
            const identifier = identifierInput.value.trim();
            identifiedModel = null;
            resultContainer.classList.remove('show');
            if (!identifier) {
                displayResult('error', 'الرجاء إدخال الرقم', `الحقل فارغ.`);
                return;
            }
            setLoading(true);

            const prompt = `You are an expert in Apple device identifiers. A user has provided the following number: '${identifier}' to be checked as a ${currentCheckType}. Based on known formats, analyze this number.
            1. Is its structure and format valid?
            2. If valid, can you determine the potential iPhone model, color, and storage from the number? (If you cannot determine a specific piece of information, leave its value as null).
            Respond in JSON format with the following fields: "isValid" (boolean), "reason" (string in Arabic), "model" (string or null), "color" (string or null), "storage" (string or null).`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    isValid: { type: "BOOLEAN" },
                    reason: { type: "STRING" },
                    model: { "type": ["STRING", "NULL"] },
                    color: { "type": ["STRING", "NULL"] },
                    storage: { "type": ["STRING", "NULL"] }
                },
                required: ["isValid", "reason"]
            };

            const analysisResult = await callGeminiAPI(prompt, null, schema);

            if (analysisResult) {
                try {
                    const jsonMatch = analysisResult.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("No valid JSON object found.");
                    const parsedResult = JSON.parse(jsonMatch[0]);
                    if (parsedResult.isValid) {
                        identifiedModel = parsedResult.model;
                        displayResult('success', `تنسيق ${currentCheckType} يبدو صالحاً`, parsedResult.reason, parsedResult);
                    } else {
                        displayResult('warning', `تنسيق ${currentCheckType} قد يكون غير صالح`, parsedResult.reason, null);
                    }
                } catch (e) {
                    displayResult('error', 'خطأ في التحليل', 'لم نتمكن من معالجة رد الذكاء الاصطناعي.');
                }
            } else {
                displayResult('error', 'خطأ في الاتصال', 'فشل الاتصال بخادم الذكاء الاصطناعي.');
            }
            setLoading(false);
        }
        
        async function getAIBatteryAnalysis() {
            const capacity = batteryCapacityInput.value;
            const cycles = batteryCyclesInput.value;
            if (!capacity) {
                aiBatteryAnalysisResult.innerHTML = `<p class="text-red-500 text-center">الرجاء إدخال الحد الأقصى للسعة.</p>`;
                return;
            }
            
            setBatteryLoading(true);
            let prompt = `As an iPhone battery expert, analyze the following data: Maximum capacity is ${capacity}%.`;
            if (cycles) prompt += ` and the cycle count is ${cycles}.`;
            if (identifiedModel) prompt += ` This device is an ${identifiedModel}.`;
            prompt += ` Based on this information, provide a brief, clear analysis in Arabic about the battery's condition. Does it seem normal? Is it degraded? Is there anything to worry about?`;

            const responseText = await callGeminiAPI(prompt);
            if (responseText) {
                aiBatteryAnalysisResult.innerHTML = `<div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">${responseText.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>`;
            } else {
                aiBatteryAnalysisResult.innerHTML = '<p class="text-red-500 text-center">عذراً، حدث خطأ أثناء تحليل البطارية.</p>';
            }
            setBatteryLoading(false);
        }

        async function getAIImageAnalysis() {
            if (!imageDataBase64) return;
            setImageLoading(true);
            const prompt = "You are an expert in detecting counterfeit iPhones. Analyze the attached image. Look for any signs that it might be a fake, such as an inaccurate logo, poor print quality, incorrect fonts, cheap materials, or any other details that do not match genuine Apple products. Provide your analysis in Arabic as a bulleted list.";
            const responseText = await callGeminiAPI(prompt, imageDataBase64);
            if (responseText) {
                aiImageAnalysisResult.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg border border-gray-200">${responseText.replace(/\* /g, '<br>• ').replace(/\n/g, '')}</div>`;
            } else {
                aiImageAnalysisResult.innerHTML = '<p class="text-red-500 text-center">عذراً، حدث خطأ أثناء تحليل الصورة.</p>';
            }
            setImageLoading(false);
        }

        function displayResult(type, title, message, specs) {
            let specsHTML = '';
            if (type === 'success' && specs) {
                specsHTML += `<div class="mt-4 pt-4 border-t border-gray-300 text-right"><h4 class="font-bold text-lg mb-2 text-gray-800">المواصفات المحددة:</h4><ul class="space-y-1">`;
                if(specs.model) specsHTML += `<li class="flex justify-between"><span>الطراز:</span><span class="font-semibold">${specs.model}</span></li>`;
                if(specs.color) specsHTML += `<li class="flex justify-between"><span>اللون:</span><span class="font-semibold">${specs.color}</span></li>`;
                if(specs.storage) specsHTML += `<li class="flex justify-between"><span>السعة:</span><span class="font-semibold">${specs.storage}</span></li>`;
                specsHTML += `</ul></div>`;
            }
            const types = {
                success: { bg: 'bg-green-50', border: 'border-green-500', text: 'text-green-700', icon: `<svg class="h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>` },
                warning: { bg: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-700', icon: `<svg class="h-12 w-12 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>` },
                error: { bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-700', icon: `<svg class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>` }
            };
            const theme = types[type];
            resultContainer.innerHTML = `
                <div class="rounded-lg p-6 text-center border-l-4 ${theme.border} ${theme.bg}">
                    <div class="flex justify-center mb-4">${theme.icon}</div>
                    <h3 class="text-xl font-bold ${theme.text}">${title}</h3>
                    <p class="mt-2 text-gray-600">${message}</p>
                    ${specsHTML}
                    <a href="https://checkcoverage.apple.com/" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition">التحقق من تغطية آبل الرسمية</a>
                </div>`;
            resultContainer.classList.add('show');
        }

        function setLoading(isLoading) {
            buttonText.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
            checkButton.disabled = isLoading;
        }

        function setImageLoading(isLoading) {
            analyzeImageButton.disabled = isLoading;
            analyzeImageButton.innerHTML = isLoading ? '<span class="spinner inline-block"></span>' : 'تحليل الصورة';
        }

        function setBatteryLoading(isLoading) {
            analyzeBatteryButton.disabled = isLoading;
            analyzeBatteryButton.innerHTML = isLoading ? '<span class="spinner inline-block"></span>' : 'تحليل البطارية';
        }

        async function callGeminiAPI(prompt, base64Data = null, jsonSchema = null) {
            const apiUrl = '/.netlify/functions/gemini';
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, base64Data, jsonSchema }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Function call failed: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("Error calling Netlify function:", error);
                return null;
            }
        }
    </script>
</body>
</html>
